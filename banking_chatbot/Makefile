# ğŸš€ Makefile para Banking Chatbot
# UbicaciÃ³n: /Makefile (raÃ­z del proyecto)

.PHONY: help install dev build clean test docker

# Colores para output
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
NC=\033[0m # No Color

help: ## ğŸ“‹ Mostrar ayuda
	@echo "$(BLUE)ğŸ¦ Banking Chatbot - Comandos Disponibles$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

install: ## ğŸ“¦ Instalar todas las dependencias
	@echo "$(YELLOW)ğŸ“¦ Instalando dependencias del backend...$(NC)"
	cd backend && pip install -r requirements.txt
	@echo "$(YELLOW)ğŸ“¦ Instalando dependencias del frontend...$(NC)"
	cd frontend/chat-widget && npm install
	@echo "$(GREEN)âœ… Dependencias instaladas correctamente$(NC)"

dev-backend: ## ğŸš€ Ejecutar backend en modo desarrollo
	@echo "$(YELLOW)ğŸš€ Iniciando backend en modo desarrollo...$(NC)"
	cd backend && python -m uvicorn api.main:app --reload --host 0.0.0.0 --port 8000

dev-frontend: ## ğŸ¨ Ejecutar frontend en modo desarrollo
	@echo "$(YELLOW)ğŸ¨ Iniciando frontend en modo desarrollo...$(NC)"
	cd frontend/chat-widget && npm run dev

dev: ## ğŸ”„ Ejecutar backend y frontend simultÃ¡neamente
	@echo "$(YELLOW)ğŸ”„ Iniciando desarrollo completo...$(NC)"
	@echo "$(BLUE)Abriendo terminales para backend y frontend$(NC)"
	@if command -v tmux >/dev/null 2>&1; then \
		tmux new-session -d -s banking-chatbot; \
		tmux split-window -h; \
		tmux send-keys -t 0 'make dev-backend' C-m; \
		tmux send-keys -t 1 'make dev-frontend' C-m; \
		tmux attach-session -s banking-chatbot; \
	else \
		echo "$(RED)âŒ tmux no estÃ¡ instalado. Ejecuta 'make dev-backend' y 'make dev-frontend' en terminales separadas$(NC)"; \
	fi

build-frontend: ## ğŸ—ï¸ Construir frontend para producciÃ³n
	@echo "$(YELLOW)ğŸ—ï¸ Construyendo frontend...$(NC)"
	cd frontend/chat-widget && npm run build
	@echo "$(GREEN)âœ… Frontend construido en frontend/chat-widget/dist$(NC)"

test-backend: ## ğŸ§ª Ejecutar tests del backend
	@echo "$(YELLOW)ğŸ§ª Ejecutando tests del backend...$(NC)"
	cd backend && python -m pytest tests/ -v

test-frontend: ## ğŸ§ª Ejecutar tests del frontend
	@echo "$(YELLOW)ğŸ§ª Ejecutando tests del frontend...$(NC)"
	cd frontend/chat-widget && npm run test

test: ## ğŸ§ª Ejecutar todos los tests
	@echo "$(YELLOW)ğŸ§ª Ejecutando todos los tests...$(NC)"
	make test-backend
	make test-frontend

lint-backend: ## ğŸ” Verificar cÃ³digo del backend
	@echo "$(YELLOW)ğŸ” Verificando cÃ³digo del backend...$(NC)"
	cd backend && python -m flake8 . --max-line-length=100 --exclude=__pycache__,migrations

lint-frontend: ## ğŸ” Verificar cÃ³digo del frontend
	@echo "$(YELLOW)ğŸ” Verificando cÃ³digo del frontend...$(NC)"
	cd frontend/chat-widget && npm run lint

lint: ## ğŸ” Verificar todo el cÃ³digo
	make lint-backend
	make lint-frontend

clean: ## ğŸ§¹ Limpiar archivos temporales
	@echo "$(YELLOW)ğŸ§¹ Limpiando archivos temporales...$(NC)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	rm -rf backend/.pytest_cache
	rm -rf frontend/chat-widget/node_modules/.cache
	rm -rf frontend/chat-widget/dist
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

docker-build: ## ğŸ³ Construir imÃ¡genes Docker
	@echo "$(YELLOW)ğŸ³ Construyendo imÃ¡genes Docker...$(NC)"
	docker build -t banking-chatbot-api ./backend
	docker build -t banking-chatbot-frontend ./frontend/chat-widget
	@echo "$(GREEN)âœ… ImÃ¡genes Docker construidas$(NC)"

docker-up: ## ğŸ³ Ejecutar con Docker Compose
	@echo "$(YELLOW)ğŸ³ Iniciando servicios con Docker Compose...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)âœ… Servicios iniciados$(NC)"
	@echo "$(BLUE)ğŸŒ Frontend: http://localhost:3000$(NC)"
	@echo "$(BLUE)ğŸ“¡ Backend API: http://localhost:8000$(NC)"
	@echo "$(BLUE)ğŸ“š API Docs: http://localhost:8000/docs$(NC)"

docker-down: ## ğŸ³ Detener servicios Docker
	@echo "$(YELLOW)ğŸ³ Deteniendo servicios Docker...$(NC)"
	docker-compose down
	@echo "$(GREEN)âœ… Servicios detenidos$(NC)"

logs: ## ğŸ“‹ Ver logs de la aplicaciÃ³n
	@echo "$(YELLOW)ğŸ“‹ Mostrando logs...$(NC)"
	docker-compose logs -f

setup: install ## ğŸ¯ Setup inicial completo del proyecto
	@echo "$(YELLOW)ğŸ¯ Setup inicial del proyecto...$(NC)"
	mkdir -p data/documents data/models logs
	cp config/secrets.yaml.template config/secrets.yaml || true
	@echo "$(GREEN)âœ… Setup inicial completado$(NC)"
	@echo "$(BLUE)ğŸ“ Recuerda configurar las variables en config/secrets.yaml$(NC)"

status: ## ğŸ“Š Ver estado de servicios
	@echo "$(BLUE)ğŸ“Š Estado de los servicios:$(NC)"
	@echo ""
	@curl -s http://localhost:8000/api/v1/health 2>/dev/null | python -m json.tool || echo "$(RED)âŒ Backend no disponible$(NC)"
	@echo ""
	@curl -s http://localhost:3000 2>/dev/null >/dev/null && echo "$(GREEN)âœ… Frontend disponible en http://localhost:3000$(NC)" || echo "$(RED)âŒ Frontend no disponible$(NC)"

quick-start: ## âš¡ Inicio rÃ¡pido para desarrollo
	@echo "$(BLUE)âš¡ Inicio rÃ¡pido del proyecto$(NC)"
	@echo "$(YELLOW)1. Instalando dependencias...$(NC)"
	@make install
	@echo "$(YELLOW)2. Iniciando servicios de desarrollo...$(NC)"
	@make dev

# Comandos de producciÃ³n
deploy-staging: ## ğŸš€ Deploy a staging
	@echo "$(YELLOW)ğŸš€ Deploying a staging...$(NC)"
	# AquÃ­ irÃ­an los comandos especÃ­ficos de deploy

deploy-prod: ## ğŸŒŸ Deploy a producciÃ³n
	@echo "$(RED)âš ï¸  Deploy a producciÃ³n requiere confirmaciÃ³n$(NC)"
	@echo "$(YELLOW)Ejecuta: make deploy-prod-confirm$(NC)"

deploy-prod-confirm: ## ğŸŒŸ Confirmar deploy a producciÃ³n
	@echo "$(RED)ğŸŒŸ Deploying a PRODUCCIÃ“N...$(NC)"
	# AquÃ­ irÃ­an los comandos especÃ­ficos de deploy a prod